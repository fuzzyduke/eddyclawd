services:
  "{{APP_NAME}}":
    container_name: "{{APP_NAME}}-service"
    image: nginx:1.27-alpine # Alpine includes wget for healthchecks
    restart: unless-stopped
    env_file: /srv/secrets/{{APP_NAME}}.env

    # üîó Network: Attach to external Traefik proxy
    networks:
      - proxy

    # üîí Security: No host ports exposed.
    # ports:
    #   - "8080:80" # BLOCKED

    # üöÄ Resources: Compose-enforced limits
    mem_limit: 256m
    cpus: 0.5

    # ‚úÖ Health: Works out-of-the-box in Alpine
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:80/ >/dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # üó∫Ô∏è Traefik: Proxy routing & TLS
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Routing: Hardcoded Host rule with backticks
      - "traefik.http.routers.{{APP_NAME}}.rule=Host(`{{SUBDOMAIN}}.valhallala.com`)"
      - "traefik.http.routers.{{APP_NAME}}.entrypoints=websecure"
      - "traefik.http.routers.{{APP_NAME}}.tls=true"
      - "traefik.http.routers.{{APP_NAME}}.tls.certresolver=letsencrypt"
      - "traefik.http.services.{{APP_NAME}}.loadbalancer.server.port={{INTERNAL_PORT}}"

    # üíæ Storage: Use named volumes for persistence
    volumes:
      - "{{APP_NAME}}-data:/usr/share/nginx/html"

networks:
  proxy:
    external: true
